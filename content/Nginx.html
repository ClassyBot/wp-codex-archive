<div style="background-color:#FAEBD7; border:1px solid #CCCCCC; color:#000000; padding:7px; margin:0.5em auto 0.5em auto; vertical-align:middle; overflow:hidden;">This page is <a href="https://codex.wordpress.org/Category:Stubs" title="Category:Stubs">marked</a> as incomplete. You can <a href="https://codex.wordpress.org/Codex:Contributing" title="Codex:Contributing">help</a> Codex by <b><a rel="nofollow" class="external text" href="https://codex.wordpress.org/index.php?title=Nginx&amp;action=edit">expanding it</a></b>.</div>
<p class="LanguageLinks" style="border:1px solid #CCCCCC; line-height:1.5; text-align:left; color:#333333; font-size:90%; padding:10px;"><span style="white-space:nowrap;"><a href="https://codex.wordpress.org/Multilingual_Codex" title="Multilingual Codex" class="mw-redirect">Languages</a>:</span> 
<strong class="selflink">English</strong> • 
<a rel="nofollow" class="external text" href="https://wpdocs.osdn.jp/Nginx">日本語</a> 
 <small>(<a href="https://codex.wordpress.org/Multilingual_Codex#Language_Cross_Reference" title="Multilingual Codex" class="mw-redirect">Add your language</a>)</small>
</p>
<p>While the LAMP stack (Linux + Apache + MySQL + PHP) is very popular for powering WordPress, it is also possible to use Nginx. WordPress supports Nginx, and some large WordPress sites, such as WordPress.com, are powered by Nginx.
</p><p>When talking about Nginx, it is important to know that there are multiple ways to implement Nginx. It can be setup as a reverse-proxy in front of Apache, which is a very powerful setup that allows you to use all of the features and power of Apache, while benefitting from the speed of Nginx. Most websites that report using Nginx as the server (based on stats gathered from HTTP response headers), are actually Apache running with Nginx as the reverse proxy. (The HTTP response headers showing "Nginx" are being reported by the reverse-proxy, not the server itself.)
</p><p><b>This guide is referring to a <i>standalone Nginx</i> setup, where it is used as the primary server <i>instead of</i> Apache.</b> It should be noted that Nginx is not a completely interchangeable substitute for Apache. There are a few key differences affecting WordPress implementation that you need to be aware of before you proceed:
</p>
<ul><li> With Nginx there is no directory-level configuration file like Apache's .htaccess or IIS's web.config files. All configuration has to be done at the server level by an administrator, and <i>WordPress cannot modify the configuration</i>, like it can with Apache or IIS.</li>
<li> Pretty Permalinks functionality is slightly different when running Nginx.</li>
<li> Since Nginx does not have .htaccess-type capability and WordPress cannot automatically modify the server configuration for you, it cannot generate the rewrite rules for you.</li>
<li> Without modifications to your install, "index.php" will be added to your Permalinks. (There are ways to mitigate this with plugins (see below) and/or adding custom code to your child theme's functions.php.)</li>
<li> However, if you do want to have some (limited) .htaccess capability, it is technically possible to do add by installing the <a rel="nofollow" class="external text" href="http://php.net/manual/en/book.htscanner.php">htscanner PECL extension for PHP</a>. (However, this is not a perfect solution so be sure to test and debug thoroughly before using on a live site.)</li></ul>
<p>This guide is <b>not going to cover</b> how to install and configure Nginx, so this assumes that you have already installed Nginx and have a basic understanding of how to work with and debug it.
</p>
<div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Generic_and_Multi-Site_Support"><span class="tocnumber">1</span> <span class="toctext">Generic and Multi-Site Support</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#Main_.28generic.29_startup_file"><span class="tocnumber">1.1</span> <span class="toctext">Main (generic) startup file</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#Per_Site_configuration"><span class="tocnumber">1.2</span> <span class="toctext">Per Site configuration</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#Global_restrictions_file"><span class="tocnumber">1.3</span> <span class="toctext">Global restrictions file</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#General_WordPress_rules"><span class="tocnumber">1.4</span> <span class="toctext">General WordPress rules</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#WordPress_Multisite_Subdirectory_rules"><span class="tocnumber">1.5</span> <span class="toctext">WordPress Multisite Subdirectory rules</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#WordPress_Multisite_subdomains_rules"><span class="tocnumber">1.6</span> <span class="toctext">WordPress Multisite subdomains rules</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#HTTPS_in_Nginx"><span class="tocnumber">1.7</span> <span class="toctext">HTTPS in Nginx</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="#WP_Super_Cache_Rules"><span class="tocnumber">1.8</span> <span class="toctext">WP Super Cache Rules</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="#W3_Total_Cache_Rules"><span class="tocnumber">1.9</span> <span class="toctext">W3 Total Cache Rules</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-11"><a href="#Nginx_fastcgi_cache"><span class="tocnumber">2</span> <span class="toctext">Nginx fastcgi_cache</span></a></li>
<li class="toclevel-1 tocsection-12"><a href="#Better_Performance_for_Static_Files_in_Multisite"><span class="tocnumber">3</span> <span class="toctext">Better Performance for Static Files in Multisite</span></a>
<ul>
<li class="toclevel-2 tocsection-13"><a href="#Notes"><span class="tocnumber">3.1</span> <span class="toctext">Notes</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-14"><a href="#Notes_2"><span class="tocnumber">4</span> <span class="toctext">Notes</span></a></li>
<li class="toclevel-1 tocsection-15"><a href="#Warning"><span class="tocnumber">5</span> <span class="toctext">Warning</span></a></li>
<li class="toclevel-1 tocsection-16"><a href="#Resources"><span class="tocnumber">6</span> <span class="toctext">Resources</span></a>
<ul>
<li class="toclevel-2 tocsection-17"><a href="#Reference"><span class="tocnumber">6.1</span> <span class="toctext">Reference</span></a></li>
<li class="toclevel-2 tocsection-18"><a href="#External_Links"><span class="tocnumber">6.2</span> <span class="toctext">External Links</span></a></li>
<li class="toclevel-2 tocsection-19"><a href="#Scripts_.26_Tools"><span class="tocnumber">6.3</span> <span class="toctext">Scripts &amp; Tools</span></a></li>
<li class="toclevel-2 tocsection-20"><a href="#Securing_Nginx"><span class="tocnumber">6.4</span> <span class="toctext">Securing Nginx</span></a></li>
</ul>
</li>
</ul>
</div>

<h2><span class="mw-headline" id="Generic_and_Multi-Site_Support">Generic and Multi-Site Support</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=1" title="Edit section: Generic and Multi-Site Support">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>To make WordPress work with Nginx you have to configure the backend php-cgi.  The options available are 'fastcgi' or 'php-fpm'.  Here, php-fpm is being used because it is included with PHP 5.3+, so installing it is straight forward.
</p><p>The Nginx configuration has been broken up into five distinct files and is heavily commented to make each option easier to understand. The <a rel="nofollow" class="external text" href="http://wordpress.org/support/profile/bigsite">author</a> also made a best-effort attempting to follow "best practices" for nginx configurations.
</p>
<h3><span class="mw-headline" id="Main_.28generic.29_startup_file">Main (generic) startup file</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=2" title="Edit section: Main (generic) startup file">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>This is equivalent to /etc/nginx/nginx.conf (or /etc/nginx/conf/nginx.conf if you're using Arch Linux).
</p>
<pre>
# Generic startup file.
user {user} {group};

#usually equal to number of CPUs you have. run command "grep processor /proc/cpuinfo | wc -l" to find it
worker_processes  auto;
worker_cpu_affinity auto;

error_log  /var/log/nginx/error.log;
pid        /var/run/nginx.pid;

# Keeps the logs free of messages about not being able to bind().
#daemon     off;

events {
	worker_connections  1024;
}

http {
#	rewrite_log on;

	include mime.types;
	default_type       application/octet-stream;
	access_log         /var/log/nginx/access.log;
	sendfile           on;
#	tcp_nopush         on;
	keepalive_timeout  3;
#	tcp_nodelay        on;
#	gzip               on;
        #php max upload limit cannot be larger than this       
	client_max_body_size 13m;
	index              index.php index.html index.htm;

	# Upstream to abstract backend connection(s) for PHP.
	upstream php {
                #this should match value of "listen" directive in php-fpm pool
		server unix:/tmp/php-fpm.sock;
#		server 127.0.0.1:9000;
	}

	include sites-enabled/*;
}
</pre>
<p>This is a bit different from standard nginx.conf files. This configuration follows the Ubuntu/Debian method of declaring enabled sites for maximum flexibility - using 'sites-available' to store a config and then symlink to the config file from 'sites-enabled'.
</p>
<h3><span class="mw-headline" id="Per_Site_configuration">Per Site configuration</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=3" title="Edit section: Per Site configuration">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<pre>
# Redirect everything to the main site. We use a separate server statement and NOT an if statement - see http://wiki.nginx.org/IfIsEvil

server {
        server_name  _;
        return 302 $scheme://example.com$request_uri;
}

server {
	server_name example.com;
	root /var/www/example.com;

	index index.php;

	include global/restrictions.conf;

	# Additional rules go here.

	# Only include one of the files below.
	include global/wordpress.conf;
#	include global/wordpress-ms-subdir.conf;
#	include global/wordpress-ms-subdomain.conf;
}
</pre>
<p>Splitting sections of the configuration into multiple files allows the same logic to be reused over and over. A 'global' subdirectory is used to add extra rules for general purpose use (either /etc/nginx/conf/global/ or /etc/nginx/global/ depending on how your nginx install is set up).
</p>
<h3><span class="mw-headline" id="Global_restrictions_file">Global restrictions file</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=4" title="Edit section: Global restrictions file">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<pre>
# Global restrictions configuration file.
# Designed to be included in any server {} block.
location = /favicon.ico {
	log_not_found off;
	access_log off;
}
# robots.txt fallback to index.php
location = /robots.txt {
# Some WordPress plugin gererate robots.txt file
    allow all;
    try_files $uri $uri/ /index.php?$args @robots;
    access_log off;
    log_not_found off;
}
# additional fallback if robots.txt doesn't exist
location @robots {
   return 200 "User-agent: *\nDisallow: /wp-admin/\nAllow: /wp-admin/admin-ajax.php\n";
}

# Deny all attempts to access hidden files such as .htaccess, .htpasswd, .DS_Store (Mac) excepted .well-known directory.
# Keep logging the requests to parse later (or to pass to firewall utilities such as fail2ban)
location ~ /\.(?!well-known\/) {
    deny all;
}

# Deny access to any files with a .php extension in the uploads directory for the single site
location /wp-content/uploads {
    location ~ \.php$ {
        deny all;
    }
}


# Deny access to any files with a .php extension in the uploads directory
# Works in sub-directory installs and also in multisite network
# Keep logging the requests to parse later (or to pass to firewall utilities such as fail2ban)
location ~* /(?:uploads|files)/.*\.php$ {
	deny all;
}

</pre>
<h3><span class="mw-headline" id="General_WordPress_rules">General WordPress rules</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=5" title="Edit section: General WordPress rules">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>For single site installations, here is the 'global/wordpress.conf' file:
</p>
<pre>
# WordPress single site rules.
# Designed to be included in any server {} block.
# Upstream to abstract backend connection(s) for php
upstream php {
        server unix:/tmp/php-cgi.socket;
        server 127.0.0.1:9000;
}

server {
        ## Your website name goes here.
        server_name domain.tld;
        ## Your only path reference.
        root /var/www/wordpress;
        ## This should be in your http block and if it is, it's not needed here.
        index index.php;

        location = /favicon.ico {
                log_not_found off;
                access_log off;
                expires max;
        }

        location = /robots.txt {
                allow all;
                log_not_found off;
                access_log off;
        }

        location / {
                # This is cool because no php is touched for static content.
                # include the "$is_args$args" so non-default permalinks doesn't break when using query string
                try_files $uri $uri/ /index.php$is_args$args;
        }

        location ~ \.php$ {
                #NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
                include fastcgi.conf;
                fastcgi_intercept_errors on;
                fastcgi_pass php;
                fastcgi_buffers 16 16k;
                fastcgi_buffer_size 32k;
        }

        location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
                expires max;
                access_log off;
                log_not_found off;
        }
}
</pre>
<p>This is more uptodate example for nginx v .10 and ↑. Ref: <a rel="nofollow" class="external free" href="https://www.nginx.com/resources/wiki/start/topics/recipes/wordpress/">https://www.nginx.com/resources/wiki/start/topics/recipes/wordpress/</a> <br /> 
WordPress 5.x Query parameters support with Nginx. Ref: 
<a rel="nofollow" class="external free" href="https://developer.wordpress.org/rest-api/using-the-rest-api/frequently-asked-questions/">https://developer.wordpress.org/rest-api/using-the-rest-api/frequently-asked-questions/</a>
</p>
<h3><span class="mw-headline" id="WordPress_Multisite_Subdirectory_rules">WordPress Multisite Subdirectory rules</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=6" title="Edit section: WordPress Multisite Subdirectory rules">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>For multisite subdirectory installations, here is the 'global/wordpress.conf' file:
</p>
<pre>
# WordPress multisite subdirectory rules.
# Designed to be included in any server {} block.

map $uri $blogname{
    ~^(?P&lt;blogpath&gt;/[^/]+/)files/(.*)       $blogpath&#160;;
}

map $blogname $blogid{
    default -999;

    #Ref: http://wordpress.org/extend/plugins/nginx-helper/
    #include /var/www/wordpress/wp-content/plugins/nginx-helper/map.conf&#160;;
}

server {
    server_name example.com&#160;;

    root /var/www/example.com/htdocs;
    index index.php;

    location ~ ^(/[^/]+/)?files/(.+) {
        try_files /wp-content/blogs.dir/$blogid/files/$2 /wp-includes/ms-files.php?file=$2&#160;;
        access_log off;     log_not_found off; expires max;
    }

    #avoid php readfile()
    location ^~ /blogs.dir {
        internal;
        alias /var/www/example.com/htdocs/wp-content/blogs.dir&#160;;
        access_log off;     log_not_found off; expires max;
    }

    if (!-e $request_filename) {
        # Don't use `$uri` here, see https://github.com/yandex/gixy/issues/77
        rewrite /wp-admin$ $scheme://$host$request_uri/ permanent;
        rewrite ^(/[^/]+)?(/wp-.*) $2 last;
        rewrite ^(/[^/]+)?(/.*\.php) $2 last;
    }

    location / {
        try_files $uri $uri/ /index.php?$args&#160;;
    }

    location ~ \.php$ {
        try_files $uri =404;
        include fastcgi_params;
        fastcgi_pass php;
    }

    #add some rules for static content expiry-headers here
}

</pre>
<p>NGINX provides 2 special directive: X-Accel-Redirect &lt;x-accel.redirect_&gt; and map. Using these 2 directives, one can eliminate performance hit for static-file serving on WordPress multisite network. 
</p><p>Note: WordPress Network installs no longer need the `blogs.dir` rules when creating a network, however may still be needed when migrating older installations.
</p>
<h3><span class="mw-headline" id="WordPress_Multisite_subdomains_rules">WordPress Multisite subdomains rules</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=7" title="Edit section: WordPress Multisite subdomains rules">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<pre>
map $http_host $blogid {
    default       -999;

    #Ref: http://wordpress.org/extend/plugins/nginx-helper/
    #include /var/www/wordpress/wp-content/plugins/nginx-helper/map.conf&#160;;

}

server {
    server_name example.com *.example.com&#160;;

    root /var/www/example.com/htdocs;
    index index.php;

    location / {
        try_files $uri $uri/ /index.php?$args&#160;;
    }

    location ~ \.php$ {
        try_files $uri =404;
        include fastcgi_params;
        fastcgi_pass php;
    }

    #WPMU Files
        location ~ ^/files/(.*)$ {
                try_files /wp-content/blogs.dir/$blogid/$uri /wp-includes/ms-files.php?file=$1&#160;;
                access_log off; log_not_found off;      expires max;
        }

    #WPMU x-sendfile to avoid php readfile()
    location ^~ /blogs.dir {
        internal;
        alias /var/www/example.com/htdocs/wp-content/blogs.dir;
        access_log off;     log_not_found off;      expires max;
    }

    #add some rules for static content expiry-headers here
}
</pre>
<p>Ref: <a rel="nofollow" class="external free" href="https://www.nginx.com/resources/wiki/start/topics/recipes/wordpress/">https://www.nginx.com/resources/wiki/start/topics/recipes/wordpress/</a>
</p><p>Note: WordPress Network installs no longer need the `blogs.dir` rules when creating a network, however may still be needed when migrating older installations.
</p>
<h3><span class="mw-headline" id="HTTPS_in_Nginx">HTTPS in Nginx</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=8" title="Edit section: HTTPS in Nginx">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>Enabling HTTPS in Nginx is relatively simple.
</p>
<pre>
server {
    # listens both on IPv4 and IPv6 on 443 and enables HTTPS and HTTP/2 support.
    # HTTP/2 is available in nginx 1.9.5 and above.
    listen *:443 ssl http2;
    listen [::]:443 ssl http2;

    # indicate locations of SSL key files.
    ssl_certificate /srv/www/ssl/ssl.crt;
    ssl_certificate_key /srv/www/ssl/ssl.key;
    ssl_dhparam /srv/www/master/ssl/dhparam.pem;
    
    # indicate the server name
    server_name example.com *.example.com;

    # Enable HSTS. This forces SSL on clients that respect it, most modern browsers. The includeSubDomains flag is optional.
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";

    # Set caches, protocols, and accepted ciphers. This config will merit an A+ SSL Labs score as of Sept 2015.
    ssl_session_cache shared:SSL:20m;
    ssl_session_timeout 10m;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-RSA-AES256-SHA:ECDHE-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:CAMELLIA256-SHA:CAMELLIA128-SHA256;
}
</pre>
<p>Mozilla offers an <a rel="nofollow" class="external text" href="https://mozilla.github.io/server-side-tls/ssl-config-generator/">excellent SSL config generation tool</a> as well.
</p>
<h3><span class="mw-headline" id="WP_Super_Cache_Rules">WP Super Cache Rules</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=9" title="Edit section: WP Super Cache Rules">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<pre>
# WP Super Cache rules.
# Designed to be included from a 'wordpress-ms-...' configuration file.

set $cache_uri $request_uri;

# POST requests and urls with a query string should always go to PHP
if ($request_method = POST) {
        set $cache_uri 'null cache';
}
   
if ($query_string&#160;!= "") {
        set $cache_uri 'null cache';
}   

# Don't cache uris containing the following segments
if ($request_uri ~* "(/wp-admin/|/xmlrpc.php|/wp-(app|cron|login|register|mail).php|wp-.*.php|/feed/|index.php|wp-comments-popup.php|wp-links-opml.php|wp-locations.php|sitemap(_index)?.xml|[a-z0-9_-]+-sitemap([0-9]+)?.xml)") {
        set $cache_uri 'null cache';
}   

# Don't use the cache for logged in users or recent commenters
if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_logged_in") {
        set $cache_uri 'null cache';
}

# START MOBILE
# Mobile browsers section to server them non-cached version. COMMENTED by default as most modern wordpress themes including twenty-eleven are responsive. Uncomment config lines in this section if you want to use a plugin like WP-Touch
# if ($http_x_wap_profile) {
#        set $cache_uri 'null cache';
#}

#if ($http_profile) {
#        set $cache_uri 'null cache';
#}

#if ($http_user_agent ~* (2.0\ MMP|240x320|400X240|AvantGo|BlackBerry|Blazer|Cellphone|Danger|DoCoMo|Elaine/3.0|EudoraWeb|Googlebot-Mobile|hiptop|IEMobile|KYOCERA/WX310K|LG/U990|MIDP-2.|MMEF20|MOT-V|NetFront|Newt|Nintendo\ Wii|Nitro|Nokia|Opera\ Mini|Palm|PlayStation\ Portable|portalmmm|Proxinet|ProxiNet|SHARP-TQ-GX10|SHG-i900|Small|SonyEricsson|Symbian\ OS|SymbianOS|TS21i-10|UP.Browser|UP.Link|webOS|Windows\ CE|WinWAP|YahooSeeker/M1A1-R2D2|iPhone|iPod|Android|BlackBerry9530|LG-TU915\ Obigo|LGE\ VX|webOS|Nokia5800)) {
 #       set $cache_uri 'null cache';
#}

#if ($http_user_agent ~* (w3c\ |w3c-|acs-|alav|alca|amoi|audi|avan|benq|bird|blac|blaz|brew|cell|cldc|cmd-|dang|doco|eric|hipt|htc_|inno|ipaq|ipod|jigs|kddi|keji|leno|lg-c|lg-d|lg-g|lge-|lg/u|maui|maxo|midp|mits|mmef|mobi|mot-|moto|mwbp|nec-|newt|noki|palm|pana|pant|phil|play|port|prox|qwap|sage|sams|sany|sch-|sec-|send|seri|sgh-|shar|sie-|siem|smal|smar|sony|sph-|symb|t-mo|teli|tim-|tosh|tsm-|upg1|upsi|vk-v|voda|wap-|wapa|wapi|wapp|wapr|webc|winw|winw|xda\ |xda-)) {
  #      set $cache_uri 'null cache';
#}
#END MOBILE

# Use cached or actual file if they exists, otherwise pass request to WordPress
location / {
        try_files /wp-content/cache/supercache/$http_host/$cache_uri/index.html $uri $uri/ /index.php?$args&#160;;
}    
</pre>
<p><b>Experimental modifications:</b>
</p><p>If you are using HTTPS, the latest development version of WP Super Cache may use a different directory structure to differentiate between HTTP and HTTPS. try_files line may look like below:
</p>
<pre>
location / {
        try_files /wp-content/cache/supercache/$http_host/$cache_uri/index-https.html $uri $uri/ /index.php?$args&#160;;
}
</pre>
<h3><span class="mw-headline" id="W3_Total_Cache_Rules">W3 Total Cache Rules</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=10" title="Edit section: W3 Total Cache Rules">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>W3 Total Cache uses different directory structure for disk-based cache storage depending on WordPress configuration. 
</p><p>Cache validation checks will remain common as shown below:
</p>
<pre>
#W3 TOTAL CACHE CHECK 
set $cache_uri $request_uri;

# POST requests and urls with a query string should always go to PHP
if ($request_method = POST) {
        set $cache_uri 'null cache';
}   
if ($query_string&#160;!= "") {
        set $cache_uri 'null cache';
}   

# Don't cache uris containing the following segments
if ($request_uri ~* "(/wp-admin/|/xmlrpc.php|/wp-(app|cron|login|register|mail).php|wp-.*.php|/feed/|index.php|wp-comments-popup.php|wp-links-opml.php|wp-locations.php|sitemap(_index)?.xml|[a-z0-9_-]+-sitemap([0-9]+)?.xml)") {
        set $cache_uri 'null cache';
}   

# Don't use the cache for logged in users or recent commenters
if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_logged_in") {
        set $cache_uri 'null cache';
}
#ADD mobile rules from WP SUPER CACHE section above

#APPEND A CODE BLOCK FROM BELOW...
</pre>
<p><b>FOR Normal WordPress (without Multisite)</b>
Use following:
</p>
<pre>
# Use cached or actual file if they exists, otherwise pass request to WordPress
location / {
        try_files /wp-content/w3tc/pgcache/$cache_uri/_index.html $uri $uri/ /index.php?$args&#160;;
}    
</pre>
<p><b>FOR Multisite with subdirectories</b>
Use following:
</p>
<pre>
if ($request_uri ~* "^/([_0-9a-zA-Z-]+)/.*" ){
        set $blog $1;
}

set $blog "${blog}.";

if ( $blog = "blog." ){
        set $blog "";
}

# Use cached or actual file if they exists, otherwise pass request to WordPress
location / {
        try_files /wp-content/w3tc-$blog$host/pgcache$cache_uri/_index.html $uri $uri/ /index.php?$args&#160;;
}
</pre>
<p><b>FOR Multisite with Subdomains/Domain-mapping</b>
Use following:
</p>
<pre>
location / {
        try_files /wp-content/w3tc-$host/pgcache/$cache_uri/_index.html $uri $uri/ /index.php?$args;
}
</pre>
<p><b>Notes</b>
</p>
<ul><li> Nginx can handle gzip &amp; browser cache automatically so better leave that part to nginx. </li>
<li> W3 Total Cache Minify rules will work with above config without any issues.</li></ul>
<h2><span class="mw-headline" id="Nginx_fastcgi_cache">Nginx fastcgi_cache</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=11" title="Edit section: Nginx fastcgi cache">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>Nginx can perform caching on its own end to reduce load on your server. 
When you want to use Nginx's built-in fastcgi_cache, you better compile nginx with <a rel="nofollow" class="external text" href="https://github.com/FRiCKLE/ngx_cache_purge">fastcgi_cache_purge</a> module. It will help nginx purge cache for a page when it gets edited. On the WordPress side, you need to install a plugin like <a rel="nofollow" class="external text" href="https://wordpress.org/plugins/nginx-helper/">Nginx Helper</a> to utilize fastcgi_cache_purge feature.
</p><p>For Ubuntu users, you can use <a rel="nofollow" class="external text" href="https://launchpad.net/~brianmercer/+archive/nginx">launchpad repo by Brian Mercer</a> to install/upgrade nginx with fastcgi_cache_purge support.
</p><p>Config will look like below:
</p><p><b>Define a Nginx cache zone in http{...} block, outside server{...} block</b>
</p>
<pre>
#move next 3 lines to /etc/nginx/nginx.conf if you want to use fastcgi_cache across many sites 
fastcgi_cache_path /var/run/nginx-cache levels=1:2 keys_zone=WORDPRESS:500m inactive=60m;
fastcgi_cache_key "$scheme$request_method$host$request_uri";
fastcgi_cache_use_stale error timeout invalid_header http_500;
</pre>
<p><b>For wordpress site config, in server{..} block add a cache check block as follow</b>
</p>
<pre>
#fastcgi_cache start
set $no_cache 0;

# POST requests and urls with a query string should always go to PHP
if ($request_method = POST) {
        set $no_cache 1;
}   
if ($query_string&#160;!= "") {
        set $no_cache 1;
}   

# Don't cache uris containing the following segments
if ($request_uri ~* "(/wp-admin/|/xmlrpc.php|/wp-(app|cron|login|register|mail).php|wp-.*.php|/feed/|index.php|wp-comments-popup.php|wp-links-opml.php|wp-locations.php|sitemap(_index)?.xml|[a-z0-9_-]+-sitemap([0-9]+)?.xml)") {
        set $no_cache 1;
}   

# Don't use the cache for logged in users or recent commenters
if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") {
        set $no_cache 1;
} 
</pre>
<p><b>Then make changes to PHP handling block</b>
</p><p>Just add this to the following php block. Note the line <code>fastcgi_cache_valid 200 60m;</code> which tells nginx only to cache 200 responses(normal pages), which means that redirects are not cached. This is important for multilanguage sites where, if not implemented, nginx would cache the main url in one language instead of redirecting users to their respective content according to their language.
</p>
<pre>
         fastcgi_cache_bypass $no_cache;
         fastcgi_no_cache $no_cache;

         fastcgi_cache WORDPRESS;
         fastcgi_cache_valid 200 60m;
</pre>
<p>Such that it becomes something like this
</p>
<pre>
location ~ [^/]\.php(/|$) {
	fastcgi_split_path_info ^(.+?\.php)(/.*)$;
	if (!-f $document_root$fastcgi_script_name) {
		return 404;
	}
	# This is a robust solution for path info security issue and works with "cgi.fix_pathinfo = 1" in /etc/php.ini (default)

	include fastcgi.conf;
	fastcgi_index index.php;
#	fastcgi_intercept_errors on;
	fastcgi_pass php;

	fastcgi_cache_bypass $no_cache;
	fastcgi_no_cache $no_cache;

	fastcgi_cache WORDPRESS;
	fastcgi_cache_valid 200 60m;
}
</pre>
<p><b>Finally add a location for conditional purge</b>
</p>
<pre>
location ~ /purge(/.*) {
        # Uncomment the following two lines to allow purge only from the webserver
        #allow 127.0.0.1;
	#deny all;

        fastcgi_cache_purge WORDPRESS "$scheme$request_method$host$1";
} 
</pre>
<p>If you get an 'unknown directive "fastcgi_cache_purge"' error check that your nginx installation has fastcgi_cache_purge module.
</p>
<h2><span class="mw-headline" id="Better_Performance_for_Static_Files_in_Multisite">Better Performance for Static Files in Multisite</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=12" title="Edit section: Better Performance for Static Files in Multisite">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>By default, on a Multisite setup, a static file request brings php into picture i.e. <code>ms-files.php</code> file. You can get much better performance using Nginx <code>Map{..}</code> directive. 
</p><p>In nginx config for your site, above <code>server{..}</code> block, add a section as follows:
</p>
<pre>
map $http_host $blogid {
    default               0;

    example.com           1;
    site1.example.com     2;
    site1.com             2;
}</pre>
<p><br />
It is just a list of site-names and blog-ids. You can use <a rel="nofollow" class="external text" href="http://wordpress.org/extend/plugins/nginx-helper">Nginx helper</a> to get such a list of site-name/blog-id pairs. This plugin will also generate a <code>map.conf</code> file which you can directly include in the map{} section like this:
</p>
<pre>
map $http_host $blogid {
    default               0;

    include /path/to/map.conf&#160;;
}</pre>
<p>After creating a <code>map{..}</code> section, you just need to make one more change in your Nginx config so requests for <code>/files/</code> will be first processed using nginx <code>map{..}</code>:
</p>
<pre>location ~ ^/files/(.*)$ {
          try_files /wp-content/blogs.dir/$blogid/$uri /wp-includes/ms-files.php?file=$1&#160;;
          access_log off; log_not_found off; expires max;
 }</pre>
<h3><span class="mw-headline" id="Notes">Notes</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=13" title="Edit section: Notes">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<ul><li> Whenever a new site is created, deleted or an extra domain is mapped to an existing site, Nginx helper will update map.conf file automatically but you will still need to reload Nginx config manually. You can do that anytime later. Till then, only files for new sites will be served using php-fpm.</li>
<li> This method does not generate any symbolic links. So, there will be no issues with accidental deletes or backup scripts that follow symbolic links.</li>
<li> For large networks, this will scale-up nicely as there will be a single map.conf file.</li></ul>
<h2><span class="mw-headline" id="Notes_2">Notes</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=14" title="Edit section: Notes">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>A couple of final but important notes: This whole setup assumes that the root of the site is the blog and that all files that will be referenced reside on the host. If you put the blog in a subdirectory such as /blog, then the rules will have to be modified. Perhaps someone can take these rules and make it possible to, for instance, use a:
</p>
<pre>set $wp_subdir "/blog";
</pre>
<p>directive in the main 'server' block and have it automagically apply to the generic WP rules.
</p><p><br />
</p>
<h2><span class="mw-headline" id="Warning">Warning</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=15" title="Edit section: Warning">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<ul><li> A typo in <a rel="nofollow" class="external text" href="http://codex.wordpress.org/Nginx#Global_restrictions_file">Global restrictions file</a> can create loopholes. To test if your "uploads" directory is really protected, create a PHP file with some content (example: &lt;?php phpinfo();&#160;?&gt;), upload it to "uploads" directory (or one of its sub-directories), then try to access (execute) it from your browser.</li></ul>
<h2><span class="mw-headline" id="Resources">Resources</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=16" title="Edit section: Resources">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<h3><span class="mw-headline" id="Reference">Reference</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=17" title="Edit section: Reference">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<ul><li> <a rel="nofollow" class="external text" href="http://wordpress.org/support/topic/nginx-php-fpm-php-apc-wordpress-multisite-subdirectory-wp-super-cache">nginx + php-fpm + PHP APC + WordPress multisite (subdirectory) + WP Super Cache</a> (Thanks <a rel="nofollow" class="external text" href="http://wordpress.org/support/profile/bigsite">bigsite</a>)</li>
<li> <a rel="nofollow" class="external text" href="http://josephscott.org/archives/2010/06/wordpress-pretty-permalinks-with-nginx/">Notes on removing 'index.php' from Permalinks</a> (Can be done using <a rel="nofollow" class="external text" href="http://wordpress.org/extend/plugins/nginx-helper/">Nginx Helper Plugin</a>)</li></ul>
<h3><span class="mw-headline" id="External_Links">External Links</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=18" title="Edit section: External Links">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<ul><li> <a rel="nofollow" class="external text" href="http://wiki.nginx.org/WordPress">Nginx WordPress wiki page</a></li>
<li> <a rel="nofollow" class="external text" href="http://wiki.nginx.org/FullExample">Nginx Full Example</a></li>
<li> <a rel="nofollow" class="external text" href="http://wiki.nginx.org/FullExample2">Nginx Full Example 2</a></li>
<li> <a rel="nofollow" class="external text" href="http://library.linode.com/lemp-guides/">LEMP guides on Linode's Library</a></li>
<li> <a rel="nofollow" class="external text" href="http://library.linode.com/web-servers/nginx/">Various guides about Nginx on Linode's Library</a></li>
<li> <a rel="nofollow" class="external text" href="http://www.sitepoint.com/lightning-fast-wordpress-with-php-fpm-and-nginx/">Lightning fast WordPress with Php-fpm and Nginx</a></li>
<li> <a rel="nofollow" class="external text" href="http://wiki.nginx.org/VirtualHostExample">Virtual Hosts Examples</a></li>
<li> <a rel="nofollow" class="external text" href="http://rtcamp.com/wordpress-nginx/tutorials/">List of 20+ WordPress-Nginx Tutorials for common situations</a></li>
<li> <a rel="nofollow" class="external text" href="http://blog.martinfjordvald.com/2010/07/nginx-primer/">An introduction to Nginx configuration</a></li>
<li> <a rel="nofollow" class="external text" href="https://deliciousbrains.com/hosting-wordpress-setup-secure-virtual-server/">A comprehensive blog series on hosting WordPress yourself using Nginx</a></li>
<li> <a rel="nofollow" class="external text" href="http://centminmod.com/nginx_configure_wordpress.html">WordPress Installation CentminMod</a></li>
<li> <a rel="nofollow" class="external text" href="https://thecustomizewindows.com/2015/12/nginx-wordpress-installation-guide-steps/">Nginx WordPress Installation Guide</a></li></ul>
<h3><span class="mw-headline" id="Scripts_.26_Tools">Scripts &amp; Tools</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=19" title="Edit section: Scripts &amp; Tools">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<ul><li> For WordPress Nginx scripted installation <a rel="nofollow" class="external text" href="http://centminmod.com/nginx_configure_wordpress.html">CentminMod</a> can be used for CentOS. </li></ul>
<ul><li> Linode users can use <a rel="nofollow" class="external text" href="https://www.linode.com/stackscripts/view/9269">LEMP WordPress StackScript</a></li></ul>
<ul><li> Script by Review Signal <a rel="nofollow" class="external text" href="http://reviewsignal.com/blog/2014/06/25/40-million-hits-a-day-on-wordpress-using-a-10-vps/">LEMP WordPress Script</a></li></ul>
<ul><li> For wordpress-nginx based site management, <a rel="nofollow" class="external text" href="https://github.com/rtCamp/easyengine">EasyEngine</a> can be used. EasyEngine is collection of shell scripts for Ubuntu.</li></ul>
<h3><span class="mw-headline" id="Securing_Nginx">Securing Nginx</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="/index.php?title=Nginx&amp;action=edit&amp;section=20" title="Edit section: Securing Nginx">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<ul><li> <a rel="nofollow" class="external text" href="http://kbeezie.com/view/securing-nginx-php/">Securing Nginx and PHP</a></li>
<li> <a rel="nofollow" class="external text" href="https://nealpoole.com/blog/2011/04/setting-up-php-fastcgi-and-nginx-dont-trust-the-tutorials-check-your-configuration/">Setting up PHP-FastCGI and nginx? Don’t trust the tutorials: check your configuration!</a></li></ul>

<!-- 
NewPP limit report
Cached time: 20190211004046
Cache expiry: 86400
Dynamic content: false
CPU time usage: 0.028 seconds
Real time usage: 0.033 seconds
Preprocessor visited node count: 311/1000000
Preprocessor generated node count: 747/1000000
Post‐expand include size: 1218/2097152 bytes
Template argument size: 280/2097152 bytes
Highest expansion depth: 5/40
Expensive parser function count: 0/100
-->

<!-- 
Transclusion expansion time report (%,ms,calls,template)
100.00%    6.724      1 - -total
 55.31%    3.719      1 - Template:Languages
 43.40%    2.918      1 - Template:Stub
 24.21%    1.628      1 - Template:Message
 17.43%    1.172      1 - Template:en
 16.95%    1.140      1 - Template:ja
-->
